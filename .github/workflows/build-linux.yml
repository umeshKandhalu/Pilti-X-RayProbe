name: Linux Release

on:
  push:
    tags: [ 'v*.*.*' ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build libgtk-3-dev liblzma-dev libsecret-1-dev libjsoncpp-dev libfuse2
          
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Install app dependencies
        working-directory: ./app
        run: flutter pub get
        
      - name: Build Linux
        working-directory: ./app
        run: flutter build linux --release
        
      - name: Create AppImage
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          
          mkdir -p AppDir/usr/bin AppDir/usr/lib AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
          cp -r app/build/linux/x64/release/bundle/* AppDir/usr/
          
          cat > AppDir/usr/share/applications/pcss.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=PCSS X-Ray Analysis
          Exec=clinical_decision_support
          Icon=pcss
          Categories=Medical;
          EOF
          
          cat > AppDir/AppRun <<'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${HERE}/usr/sbin/:${HERE}/usr/games/:${HERE}/bin/:${HERE}/sbin/${PATH:+:$PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib/:${HERE}/usr/lib/i386-linux-gnu/:${HERE}/usr/lib/x86_64-linux-gnu/:${HERE}/usr/lib32/:${HERE}/usr/lib64/${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/clinical_decision_support" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          # Create .deb package
          mkdir -p deb_package/usr/local/bin
          mkdir -p deb_package/usr/local/lib/pcss-xray-analysis
          mkdir -p deb_package/usr/share/applications
          mkdir -p deb_package/usr/share/icons/hicolor/256x256/apps
          mkdir -p deb_package/DEBIAN
          
          # Copy files
          cp -r app/build/linux/x64/release/bundle/* deb_package/usr/local/lib/pcss-xray-analysis/
          ln -s /usr/local/lib/pcss-xray-analysis/clinical_decision_support deb_package/usr/local/bin/pcss-xray-analysis
          
          # Create control file
          cat > deb_package/DEBIAN/control <<EOF
          Package: pcss-xray-analysis
          Version: 1.0.1
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Pilti Smart <info@pilti.com>
          Description: PCSS X-Ray Analysis
           Clinical Decision Support System for X-Ray Analysis
          EOF
          
          # Create desktop entry
          cat > deb_package/usr/share/applications/pcss.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=PCSS X-Ray Analysis
          Exec=/usr/local/bin/pcss-xray-analysis
          Icon=pcss
          Categories=Medical;
          EOF
          
          # Build .deb
          dpkg-deb --build deb_package PCSS-XRay-Analysis_1.0.1_amd64.deb

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            PCSS-XRay-Analysis-x86_64.AppImage
            PCSS-XRay-Analysis_1.0.1_amd64.deb
          
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            PCSS-XRay-Analysis-x86_64.AppImage
            PCSS-XRay-Analysis_1.0.1_amd64.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
